# 进阶指南：创建流式响应 Agent 和使用 Meta 配置

在完成了 [快速开始指南](doc/chat/QuickStart.md) 之后，您已经了解了如何创建一个基本的 My Assistant Agent。现在，让我们更进一步，学习如何创建一个支持流式响应的 Agent，以及如何使用元数据（Meta）来配置 Agent 的行为。

本指南将涵盖两个重要概念：

1. **流式响应**：这种技术允许 Agent 逐步生成并发送响应，而不是一次性发送完整回复。这可以显著提升用户体验，特别是在生成长文本时。

2. **Meta 配置**：通过在 `agents.json` 中使用元数据，我们可以灵活地调整 Agent 的行为，而无需修改代码。

让我们开始创建一个名为 StreamAgent 的新 Agent，它将展示这两个概念的实际应用。

## 准备工作

1. 确保您已完成 [快速开始指南](doc/chat/QuickStart.md) 中的步骤。
2. 打开包含 `.ai_helper` 目录的工作文件夹。

## 创建您的 StreamAgent

1. 在 `.ai_helper/chat` 目录下创建一个新文件夹:

```shell
cd .ai_helper/chat
mkdir stream_agent
cd stream_agent
```

2. 初始化为 npm 包并安装依赖:

```shell
npm init -y
npm install -s ai-agent-response
```

3. 创建入口文件 `StreamAgent.js`:

```javascript
const { Response } = require('ai-agent-response');

class StreamAgent {
    constructor(metadata) {
        this.metadata = metadata;
        this.delay = metadata.delay || 100;
    }

    async generateReply(thread) {
        const response = new Response();
        const fakeMessage = this.generateFakeMessage(thread);
        response.setStream(this.createStream(fakeMessage));
        return response;
    }

    generateFakeMessage(thread) {
        const lastMessage = thread.messages[thread.messages.length - 1];
        return `This is a stream response to: "${lastMessage.text}". It was generated by StreamAgent.`;
    }

    async *createStream(message) {
        const words = message.split(' ');
        for (const word of words) {
            yield word + ' ';
            await new Promise(resolve => setTimeout(resolve, this.delay));
        }
    }
}

module.exports = StreamAgent;
```

4. 在 `.ai_helper/agent/chat/agents.json` 中添加新的 agent 配置:

```json
{
  "agents": [
    {
      "name": "StreamAgent",
      "path": "./stream_agent/StreamAgent.js",
      "metadata": {
        "delay": 100
      }
    }
  ]
}
```

您可以通过修改 `agents.json` 中的 `metadata` 来配置 StreamAgent 的元数据：

- `delay`: 每个单词之间的延迟时间（毫秒）。默认值为 100ms。

例如，要将延迟设置为 50 毫秒：

```json
{
  "name": "StreamAgent",
  "path": "./stream_agent/StreamAgent.js",
  "metadata": {
    "delay": 50
  }
}
```

现在我们已经创建了基本的 StreamAgent，接下来让我们详细了解它的工作原理和如何使用 Meta 配置来调整其行为。

## 激活您的 Agent

完成上述步骤后，您有两种方式使您的新 Agent 生效:

1. 点击 VSCode 中的刷新按钮
2. 重启 VSCode

之后，您就可以在创建新对话时选择您的 "StreamAgent" 了。

## 运行效果

当您成功创建并激活 StreamAgent 后，它的运行效果如下:

1. 在 VSCode 中，使用 My Assistant 插件创建一个新的对话。
2. 在 Agent 选择列表中，您会看到并可以选择 "StreamAgent"。
3. 选择 StreamAgent 后，开始与之对话。
4. 无论您输入什么消息，Agent 都会以流式方式回应，模拟实时生成文本的效果。

例如:

```
用户: "你好，世界!"
StreamAgent: "This is a stream response to: "你好，世界!". It was generated by StreamAgent."
```

这个响应会以流式方式呈现，每个单词之间有一个短暂的延迟，创造出逐字生成的效果。

## 流式响应的工作原理

StreamAgent 使用流式响应来模拟实时生成文本的效果。这意味着响应会被分成多个小块（chunks）逐步发送，而不是一次性发送完整的响应。

1. 当收到用户消息时，代理生成一个模拟的响应。
2. 响应被分割成多个单词。
3. 代理创建一个异步生成器函数，逐个生成这些单词。
4. 每个单词之间有一个可配置的延迟，模拟打字效果。

## 下一步

现在您已经成功创建并了解了您的第一个支持流式响应的 My Assistant 插件，您可以:

- 尝试修改 `generateFakeMessage` 方法，实现更复杂的响应逻辑
- 探索如何将 StreamAgent 连接到实际的 AI 模型或 API
- 实现错误处理和重试机制
- 添加用户反馈机制，允许在流式生成过程中暂停或取消
- 开发针对特定领域的流式响应 Agent，如实时代码生成或长文本摘要

记住，这只是开始！流式响应为创建更具交互性和动态性的 AI 助手开辟了新的可能性。

祝您在 My Assistant 开发之旅中获得乐趣和成功！